<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate to Challenge - Rift</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        h1 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .challenge-title {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #fff3cd;
            color: #856404;
        }

        .status-validated {
            background: #d1ecf1;
            color: #0c5460;
        }

        .progress-section {
            margin-bottom: 30px;
        }

        .progress-bar-container {
            width: 100%;
            height: 40px;
            background: #f0f0f0;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: bold;
            min-width: 0;
        }

        .progress-text {
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }

        .progress-percentage {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .donation-section {
            margin-bottom: 30px;
        }

        .wallet-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .amount-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .amount-btn {
            padding: 12px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .amount-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .amount-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .custom-amount {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .custom-amount:focus {
            outline: none;
            border-color: #667eea;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #d4edda;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: #155724;
            margin-bottom: 20px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #0c5460;
        }

        .escrow-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #856404;
        }

        .escrow-info strong {
            color: #856404;
        }

        .countdown {
            font-size: 1.2em;
            font-weight: bold;
            color: #dc3545;
            margin-top: 10px;
        }

        .countdown.warning {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #888;
            font-size: 0.9em;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .donation-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            font-weight: 600;
        }

        .donation-alert.show {
            transform: translateX(0);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 1.5em;
            }

            .amount-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üéÆ</div>
            <h1>Support the Challenge</h1>
            <div class="live-indicator">
                <span class="live-dot"></span>
                Live Updates
            </div>
        </div>

        <div class="challenge-info">
            <div class="challenge-title" id="challengeTitle">Loading challenge...</div>
            <span class="status-badge status-active" id="statusBadge">Active</span>
        </div>

        <div class="progress-section">
            <div class="progress-percentage" id="progressPercentage">0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">
                    <span id="progressLabel"></span>
                </div>
            </div>
            <div class="progress-text">
                <strong id="currentAmount">0</strong> KAS / <strong id="goalAmount">0</strong> KAS
            </div>
        </div>

        <div class="donation-section">
            <h3 style="margin-bottom: 15px; color: #333;">Select Amount</h3>
            
            <div class="amount-selector">
                <button class="amount-btn" data-amount="10">10 KAS</button>
                <button class="amount-btn" data-amount="50">50 KAS</button>
                <button class="amount-btn" data-amount="100">100 KAS</button>
                <button class="amount-btn" data-amount="250">250 KAS</button>
                <button class="amount-btn" data-amount="500">500 KAS</button>
                <button class="amount-btn" data-amount="1000">1000 KAS</button>
            </div>

            <input 
                type="number" 
                class="custom-amount" 
                id="customAmount" 
                placeholder="Or enter custom amount (KAS)"
                min="1"
            >

            <div class="wallet-section">
                <div class="wallet-status">
                    <span id="walletStatus">üí≥ Wallet Not Connected</span>
                    <button class="btn-secondary" id="connectWalletBtn" style="width: auto; padding: 8px 20px; margin: 0; font-size: 0.9em;">
                        Connect Wallet
                    </button>
                </div>
                <div id="walletAddress" class="wallet-address" style="display: none;"></div>
            </div>

            <button class="btn-primary" id="donateBtn" disabled>
                <span id="donateBtnText">Select Amount to Continue</span>
            </button>
        </div>

        <div class="info-box">
            <strong>‚ö° Powered by Kaspa</strong><br>
            Instant transactions with 1-second block times. Your donation appears in real-time on the stream!
        </div>

        <div class="escrow-info" id="escrowInfo">
            <strong>üîí Escrow Protection</strong><br>
            Your donation is held securely in escrow. Funds are only released to the streamer when they complete the challenge.<br>
            If the goal isn't reached before the deadline, all donations are automatically refunded!
            <div class="countdown" id="countdown">Time remaining: calculating...</div>
        </div>

        <div class="info-box" id="walletDownloadInfo" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107;">
            <strong>üí° No Wallet Detected</strong><br>
            Install a Kaspa wallet extension to donate:<br><br>
            <a href="https://chrome.google.com/webstore/detail/kaspium/" target="_blank" class="btn" style="display: inline-block; padding: 10px 20px; margin: 5px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 0.9em;">üì• Download Kaspium</a>
            <a href="https://kasware.xyz/" target="_blank" class="btn" style="display: inline-block; padding: 10px 20px; margin: 5px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 0.9em;">üì• Download Kasware</a>
        </div>

        <div class="footer">
            Powered by <a href="https://github.com/jojo2504/Rift" target="_blank">Rift</a>
        </div>
    </div>

    <div class="donation-alert" id="donationAlert">
        Donation successful! üéâ
    </div>

    <script>
        // Get challenge ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const DEFI_ID = urlParams.get('defi') || 'piment';

        // State
        let selectedAmount = 0;
        let walletConnected = false;
        let walletAddress = '';
        let currentChallenge = null;
        let kaspaWalletAPI = null;

        // Elements
        const challengeTitle = document.getElementById('challengeTitle');
        const statusBadge = document.getElementById('statusBadge');
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const progressPercentage = document.getElementById('progressPercentage');
        const currentAmount = document.getElementById('currentAmount');
        const goalAmount = document.getElementById('goalAmount');
        const customAmount = document.getElementById('customAmount');
        const donateBtn = document.getElementById('donateBtn');
        const donateBtnText = document.getElementById('donateBtnText');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddressDiv = document.getElementById('walletAddress');
        const donationAlert = document.getElementById('donationAlert');
        const walletDownloadInfo = document.getElementById('walletDownloadInfo');

        // Amount selection
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedAmount = parseFloat(this.dataset.amount);
                customAmount.value = '';
                updateDonateButton();
            });
        });

        customAmount.addEventListener('input', function() {
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
            selectedAmount = parseFloat(this.value) || 0;
            updateDonateButton();
        });

        function updateDonateButton() {
            // Check if goal already reached
            const goalReached = currentChallenge && currentChallenge.currentAmount >= currentChallenge.goal;
            
            if (goalReached) {
                donateBtn.disabled = true;
                donateBtnText.textContent = 'üéØ Goal Reached!';
            } else if (selectedAmount > 0) {
                donateBtn.disabled = false;
                donateBtnText.textContent = `Donate ${selectedAmount} KAS`;
            } else {
                donateBtn.disabled = true;
                donateBtnText.textContent = 'Select Amount to Continue';
            }
        }

        // Real Kaspa wallet connection
        connectWalletBtn.addEventListener('click', async function() {
            if (walletConnected) {
                // Disconnect
                walletConnected = false;
                walletAddress = '';
                kaspaWalletAPI = null;
                walletStatus.textContent = 'üí≥ Wallet Not Connected';
                connectWalletBtn.textContent = 'Connect Wallet';
                walletAddressDiv.style.display = 'none';
            } else {
                // Connect to real Kaspa wallet
                connectWalletBtn.innerHTML = '<span class="loading"></span>';
                connectWalletBtn.disabled = true;
                
                try {
                    // Wait a bit for extension to load
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Try multiple detection methods
                    let walletAPI = null;
                    
                    // Method 1: window.kaspa (Kaspium/standard)
                    if (window.kaspa) {
                        console.log('Found window.kaspa');
                        walletAPI = window.kaspa;
                    }
                    // Method 2: window.kasware (Kasware extension)
                    else if (window.kasware) {
                        console.log('Found window.kasware');
                        walletAPI = window.kasware;
                    }
                    // Method 3: Check for injected providers
                    else if (window.ethereum?.isKaspa) {
                        console.log('Found ethereum.isKaspa');
                        walletAPI = window.ethereum;
                    }
                    
                    if (!walletAPI) {
                        // Show download links
                        walletDownloadInfo.style.display = 'block';
                        throw new Error('No Kaspa wallet extension detected.\n\nPlease install Kaspium or Kasware from the links below.');
                    }
                    
                    console.log('Attempting to connect to wallet...');
                    
                    // Request connection
                    if (walletAPI.requestAccounts) {
                        await walletAPI.requestAccounts();
                    } else if (walletAPI.connect) {
                        await walletAPI.connect();
                    } else if (walletAPI.enable) {
                        await walletAPI.enable();
                    }
                    
                    // Get accounts
                    let accounts = [];
                    if (walletAPI.getAccounts) {
                        accounts = await walletAPI.getAccounts();
                    } else if (walletAPI.accounts) {
                        accounts = walletAPI.accounts;
                    } else if (walletAPI.selectedAddress) {
                        accounts = [walletAPI.selectedAddress];
                    }
                    
                    console.log('Accounts retrieved:', accounts);
                    
                    if (accounts && accounts.length > 0) {
                        walletAddress = accounts[0];
                        kaspaWalletAPI = walletAPI;
                        walletConnected = true;
                        walletStatus.textContent = '‚úÖ Wallet Connected';
                        connectWalletBtn.textContent = 'Disconnect';
                        connectWalletBtn.disabled = false;
                        walletAddressDiv.textContent = walletAddress;
                        walletAddressDiv.style.display = 'block';
                        
                        // Log wallet API capabilities
                        console.log('Wallet connected successfully:', walletAddress);
                        console.log('Wallet API methods:', Object.keys(walletAPI).filter(k => typeof walletAPI[k] === 'function'));
                        console.log('Has sendTransaction:', !!walletAPI.sendTransaction);
                        console.log('Has send:', !!walletAPI.send);
                        console.log('Has request:', !!walletAPI.request);
                    } else {
                        throw new Error('No accounts found. Please create or unlock your wallet.');
                    }
                    
                } catch (error) {
                    console.error('Wallet connection error:', error);
                    let errorMsg = error.message || 'Unknown error';
                    
                    if (errorMsg.includes('User rejected')) {
                        errorMsg = 'Connection cancelled. Please try again and approve the connection.';
                    }
                    
                    alert(`‚ùå Wallet Connection Failed\n\n${errorMsg}`);
                    connectWalletBtn.textContent = 'Connect Wallet';
                    connectWalletBtn.disabled = false;
                }
            }
        });

        // Donate button
        donateBtn.addEventListener('click', async function() {
            if (!selectedAmount || selectedAmount <= 0) return;

            if (!walletConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            // Disable button during transaction
            donateBtn.disabled = true;
            donateBtnText.innerHTML = '<span class="loading"></span> Processing...';

            try {
                // Real Kaspa transaction
                console.log('kaspaWalletAPI:', kaspaWalletAPI);
                console.log('walletConnected:', walletConnected);
                
                if (!kaspaWalletAPI) {
                    throw new Error('Wallet API is null. Please reconnect your wallet.');
                }
                
                // Log available wallet methods for debugging
                console.log('Available wallet methods:', Object.keys(kaspaWalletAPI).filter(k => typeof kaspaWalletAPI[k] === 'function'));
                console.log('Available wallet properties:', Object.keys(kaspaWalletAPI));
                
                // Get challenge data and vault address
                const challengeResponse = await fetch(`/api/challenge/${DEFI_ID}`);
                const challengeData = await challengeResponse.json();
                    
                    if (!challengeData.vaultAddress) {
                        throw new Error('Vault address not configured');
                    }
                    
                    // Check if goal already reached
                    if (challengeData.currentAmount >= challengeData.goal) {
                        throw new Error(`Goal already reached! ${challengeData.currentAmount} / ${challengeData.goal} KAS\n\nNo more donations are being accepted.`);
                    }
                    
                    console.log('Network:', challengeData.network);
                    console.log('Network RPC:', challengeData.networkRPC);
                    console.log('Vault address:', challengeData.vaultAddress);
                    
                    // Validate vault address format
                    if (!challengeData.vaultAddress || !challengeData.vaultAddress.startsWith('kaspatest:')) {
                        throw new Error('Invalid vault address. Must be a valid kaspatest: address for Testnet 10.');
                    }
                    
                    // Warn if using placeholder address
                    if (challengeData.vaultAddress.includes('qqqqqqqqqqq')) {
                        if (!confirm('‚ö†Ô∏è WARNING: This is using a placeholder vault address!\n\nDonations will be sent to an invalid address.\n\nThe server admin needs to set a real VAULT_ADDRESS in .env\n\nContinue anyway for testing?')) {
                            throw new Error('Transaction cancelled - invalid vault address');
                        }
                    }
                    
                    // Try to switch wallet to testnet-10 if supported
                    if (kaspaWalletAPI.switchNetwork) {
                        try {
                            await kaspaWalletAPI.switchNetwork(challengeData.network);
                            console.log('Switched wallet to', challengeData.network);
                        } catch (e) {
                            console.warn('Could not auto-switch network:', e);
                            console.warn('Please manually switch your wallet to Testnet 10');
                        }
                    } else if (kaspaWalletAPI.request) {
                        try {
                            await kaspaWalletAPI.request({ 
                                method: 'kaspa_switchNetwork', 
                                params: { network: challengeData.network, rpc: challengeData.networkRPC } 
                            });
                            console.log('Switched wallet to', challengeData.network, 'via request');
                        } catch (e) {
                            console.warn('Could not auto-switch network via request:', e);
                        }
                    }
                    
                    // Convert KAS to sompi (1 KAS = 100,000,000 sompi)
                    const sompiAmount = Math.floor(selectedAmount * 100000000);
                    
                    // Check wallet balance using multiple methods
                    console.log('Checking wallet balance...');
                    let balance = 0;
                    let balanceChecked = false;
                    
                    // Method 1: getBalance()
                    if (kaspaWalletAPI.getBalance && !balanceChecked) {
                        try {
                            const balanceResult = await kaspaWalletAPI.getBalance();
                            console.log('getBalance() result:', balanceResult);
                            
                            if (typeof balanceResult === 'object') {
                                balance = balanceResult.balance || balanceResult.total || balanceResult.available || 0;
                            } else if (typeof balanceResult === 'number' || typeof balanceResult === 'string') {
                                balance = parseFloat(balanceResult);
                            }
                            balanceChecked = true;
                        } catch (e) {
                            console.warn('getBalance() failed:', e);
                        }
                    }
                    
                    // Method 2: request with kaspa_getBalance
                    if (kaspaWalletAPI.request && !balanceChecked) {
                        try {
                            const balanceResult = await kaspaWalletAPI.request({ method: 'kaspa_getBalance' });
                            console.log('request kaspa_getBalance result:', balanceResult);
                            
                            if (typeof balanceResult === 'object') {
                                balance = balanceResult.balance || balanceResult.total || balanceResult.available || 0;
                            } else if (typeof balanceResult === 'number' || typeof balanceResult === 'string') {
                                balance = parseFloat(balanceResult);
                            }
                            balanceChecked = true;
                        } catch (e) {
                            console.warn('request kaspa_getBalance failed:', e);
                        }
                    }
                    
                    // Method 3: Check if balance is a direct property
                    if (!balanceChecked && kaspaWalletAPI.balance !== undefined) {
                        console.log('Using wallet balance property:', kaspaWalletAPI.balance);
                        balance = kaspaWalletAPI.balance;
                        balanceChecked = true;
                    }
                    
                    console.log('Final wallet balance:', balance, 'sompi');
                    
                    // Verify sufficient balance (add buffer for network fees ~0.001 KAS)
                    const feeBuffer = 100000; // 0.001 KAS in sompi
                    const requiredAmount = sompiAmount + feeBuffer;
                    
                    if (balance <= 0) {
                        throw new Error('Could not retrieve wallet balance. Please make sure your wallet is unlocked and connected to Testnet 10.');
                    }
                    
                    if (balance < requiredAmount) {
                        const balanceKAS = (balance / 100000000).toFixed(4);
                        const requiredKAS = (requiredAmount / 100000000).toFixed(4);
                        throw new Error(`Insufficient balance!\n\nYou have: ${balanceKAS} KAS\nYou need: ${requiredKAS} KAS (including fees)\n\nMake sure you're on Kaspa Testnet 10 and have testnet funds.`);
                    }
                    
                    console.log(`Balance check passed: ${balance} sompi >= ${requiredAmount} sompi`);
                    console.log('Sending transaction to vault:', challengeData.vaultAddress);
                    
                    // Send transaction to VAULT
                    donateBtnText.innerHTML = '<span class="loading"></span> üîê Check your wallet extension to sign...';
                    
                    let txResult;
                    let txId = null;
                    
                    // Kasware API: sendKaspa(toAddress, amountInSompi)
                    if (kaspaWalletAPI.sendKaspa) {
                        console.log('Using sendKaspa method (Kasware)');
                        console.log('‚ö†Ô∏è WAITING FOR USER TO SIGN TRANSACTION IN WALLET EXTENSION...');
                        txResult = await kaspaWalletAPI.sendKaspa(challengeData.vaultAddress, sompiAmount.toString());
                        console.log('‚úÖ Transaction signed! Result:', txResult);
                        txId = txResult;
                    }
                    // Standard sendTransaction with object params
                    else if (kaspaWalletAPI.sendTransaction) {
                        console.log('Using sendTransaction method');
                        console.log('‚ö†Ô∏è WAITING FOR USER TO SIGN TRANSACTION IN WALLET EXTENSION...');
                        txResult = await kaspaWalletAPI.sendTransaction({
                            to: challengeData.vaultAddress,
                            amount: sompiAmount
                        });
                        console.log('‚úÖ Transaction signed! Result:', txResult);
                        txId = txResult.txId || txResult.transactionId || txResult.id || txResult;
                    }
                    // Generic send method
                    else if (kaspaWalletAPI.send) {
                        console.log('Using send method');
                        console.log('‚ö†Ô∏è WAITING FOR USER TO SIGN TRANSACTION IN WALLET EXTENSION...');
                        // Try both signatures
                        try {
                            txResult = await kaspaWalletAPI.send(challengeData.vaultAddress, sompiAmount);
                        } catch (e) {
                            console.warn('send(address, amount) failed, trying send({to, amount})');
                            txResult = await kaspaWalletAPI.send({
                                to: challengeData.vaultAddress,
                                amount: sompiAmount
                            });
                        }
                        console.log('send result:', txResult);
                        txId = txResult.txId || txResult.transactionId || txResult.id || txResult;
                    }
                    // Request-based API
                    else if (kaspaWalletAPI.request) {
                        console.log('Using request method');
                        try {
                            txResult = await kaspaWalletAPI.request({
                                method: 'kaspa_sendTransaction',
                                params: [challengeData.vaultAddress, sompiAmount]
                            });
                        } catch (e) {
                            console.warn('kaspa_sendTransaction failed, trying wallet_sendKaspa');
                            txResult = await kaspaWalletAPI.request({
                                method: 'wallet_sendKaspa',
                                params: {
                                    to: challengeData.vaultAddress,
                                    amount: sompiAmount
                                }
                            });
                        }
                        console.log('request result:', txResult);
                        txId = txResult.txId || txResult.transactionId || txResult.id || txResult;
                    }
                    else {
                        throw new Error('No compatible transaction method found. Available methods: ' + 
                            Object.keys(kaspaWalletAPI).filter(k => typeof kaspaWalletAPI[k] === 'function').join(', '));
                    }
                    
                    // Extract transaction ID from various response formats
                    if (!txId && typeof txResult === 'string') {
                        txId = txResult;
                    } else if (!txId && txResult) {
                        txId = txResult.txId || txResult.transactionId || txResult.id || txResult.hash || txResult.txHash;
                    }
                    
                    if (!txId) {
                        console.error('No transaction ID in result:', txResult);
                        throw new Error('Transaction may have failed - no transaction ID returned. Check your wallet for confirmation.');
                    }
                    
                    console.log('Transaction ID:', txId);
                    console.log('Transaction result:', txResult);
                    donateBtnText.innerHTML = '<span class="loading"></span> Verifying transaction...';
                    
                    // Send transaction ID and data to server for verification
                    // Server will handle retries and fetching from blockchain
                    console.log('Submitting transaction for verification...');
                    const response = await fetch(`/api/donate/${DEFI_ID}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            txId: txId,
                            donorAddress: walletAddress,
                            txData: txResult, // Include full transaction data from wallet
                            intendedAmount: selectedAmount // Send intended amount for testnet fallback
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        if (errorData.status === 'goal_reached') {
                            throw new Error(`üéØ Goal Already Reached!\n\nThe challenge goal of ${errorData.goal} KAS has been met.\nNo more donations are being accepted.`);
                        }
                        throw new Error(errorData.error || 'Server error');
                    }
                    
                    const data = await response.json();
                    
                    console.log('‚úÖ Donation verified by server:', data);
                    
                    if (data.success) {
                        const actualAmount = data.actualAmount;
                        const goalJustReached = data.goalReached;
                        const message = goalJustReached 
                            ? `üéâ Goal Reached! Donated ${actualAmount.toFixed(2)} KAS! TX: ${txId.substring(0, 8)}...` 
                            : `‚úì Donated ${actualAmount.toFixed(2)} KAS! TX: ${txId.substring(0, 8)}... üîí`;
                        showDonationAlert(message);
                        selectedAmount = 0;
                        customAmount.value = '';
                        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                        updateDonateButton();
                    }
            } catch (error) {
                console.error('Donation failed:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                donateBtnText.textContent = 'Donate';
                updateDonateButton();
            } finally {
                donateBtnText.textContent = 'Donate';
                updateDonateButton();
            }
        });

        function showDonationAlert(message) {
            donationAlert.textContent = message;
            donationAlert.classList.add('show');
            setTimeout(() => {
                donationAlert.classList.remove('show');
            }, 3000);
        }

        // Update progress display
        function updateProgress(challenge) {
            currentChallenge = challenge;
            
            const percentage = Math.min((challenge.currentAmount / challenge.goal) * 100, 100);
            const goalReached = challenge.currentAmount >= challenge.goal;
            
            challengeTitle.textContent = challenge.title;
            progressBar.style.width = percentage + '%';
            progressPercentage.textContent = Math.round(percentage) + '%';
            currentAmount.textContent = challenge.currentAmount.toFixed(2);
            goalAmount.textContent = challenge.goal;
            
            if (percentage >= 20) {
                progressLabel.textContent = Math.round(percentage) + '%';
            } else {
                progressLabel.textContent = '';
            }

            // Update status
            updateStatus(challenge.status);
            
            // Update countdown
            if (challenge.deadline) {
                updateCountdown(challenge.deadline);
            }
            
            // Disable donations if goal reached
            if (goalReached && challenge.status !== 'validated') {
                updateDonateButton();
            }
        }

        // Update countdown timer
        function updateCountdown(deadline) {
            const countdownEl = document.getElementById('countdown');
            const now = Date.now();
            const timeRemaining = deadline - now;
            
            if (timeRemaining <= 0) {
                countdownEl.textContent = '‚è∞ Deadline expired - Refunds initiated';
                countdownEl.classList.add('warning');
                return;
            }
            
            const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `Time remaining: ${hours}h ${minutes}m ${seconds}s`;
            
            if (hours < 1) {
                countdownEl.classList.add('warning');
            }
        }

        // Update countdown every second
        setInterval(() => {
            if (currentChallenge && currentChallenge.deadline) {
                updateCountdown(currentChallenge.deadline);
            }
        }, 1000);

        function updateStatus(status) {
            statusBadge.className = 'status-badge';
            
            switch(status) {
                case 'active':
                    statusBadge.classList.add('status-active');
                    statusBadge.textContent = 'üü¢ Active';
                    break;
                case 'awaiting_validation':
                    statusBadge.classList.add('status-completed');
                    statusBadge.textContent = '‚è≥ Awaiting Validation';
                    break;
                case 'validated':
                    statusBadge.classList.add('status-validated');
                    statusBadge.textContent = '‚úÖ Completed - Funds Released';
                    break;
                case 'refused':
                    statusBadge.classList.add('status-refused');
                    statusBadge.textContent = '‚ùå Refused - Refunded';
                    break;
                case 'expired':
                    statusBadge.classList.add('status-refused');
                    statusBadge.textContent = '‚è∞ Expired - Refunded';
                    break;
                case 'refunded':
                    statusBadge.classList.add('status-refused');
                    statusBadge.textContent = 'üîÑ Refunded';
                    break;
            }
        }

        // WebSocket connection for live updates
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            const socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                console.log('Connected to live updates');
            };

            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    // Initial challenge data
                    if (data.type === 'all_challenges' && data.challenges[DEFI_ID]) {
                        updateProgress(data.challenges[DEFI_ID]);
                    }

                    // Real-time update for our challenge
                    if (data.type === 'update' && data.defiId === DEFI_ID) {
                        if (currentChallenge) {
                            currentChallenge.currentAmount = data.amount;
                            currentChallenge.goal = data.goal;
                            if (data.donationsCount) {
                                currentChallenge.donationsCount = data.donationsCount;
                            }
                            updateProgress(currentChallenge);
                        }
                    }

                    // Challenge completed (goal reached)
                    if (data.type === 'challenge_completed' && data.defiId === DEFI_ID) {
                        // Fetch fresh challenge data from server to get updated status
                        fetch(`/api/challenge/${DEFI_ID}`)
                            .then(res => res.json())
                            .then(challenge => {
                                updateProgress(challenge);
                            })
                            .catch(err => console.error('Failed to fetch updated challenge:', err));
                    }

                    // Challenge validated
                    if (data.type === 'challenge_validated' && data.defiId === DEFI_ID) {
                        if (currentChallenge) {
                            currentChallenge.status = 'validated';
                            updateProgress(currentChallenge);
                        }
                    }

                    // Challenge refused
                    if (data.type === 'challenge_refused' && data.defiId === DEFI_ID) {
                        if (currentChallenge) {
                            currentChallenge.status = 'refused';
                            updateProgress(currentChallenge);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };

            socket.onclose = function() {
                console.log('Disconnected. Reconnecting in 1 second...');
                setTimeout(connectWebSocket, 1000);
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                socket.close();
            };
        }

        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
